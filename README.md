# 512890 红利低波ETF回测系统

基于市值加权的ETF持仓回测系统，支持静态和动态两种回测模式，符合基金"双十规定"。

## 🚀 快速开始

```bash
# 1. 安装依赖
npm install

# 2. 配置环境变量（创建 .env 文件）
TUSHARE_TOKEN=your_token_here

# 3. 启动服务
npm start

# 4. 访问系统
# 浏览器打开 http://localhost:3001
```

## 📊 功能说明

### 静态回测
- **原理**：使用最新披露的持仓，回测历史表现
- **适用场景**：快速评估当前持仓策略
- **展示内容**：单期持仓详情、权重分布、收益对比

### 动态回测
- **原理**：跟随ETF每次持仓披露（中报/年报），动态调整组合
- **调仓时机**：报告披露后的下一个交易日（模拟实际可操作时间）
- **权重计算**：使用调仓日当天的市值计算权重（避免前视偏差）
- **适用场景**：模拟真实投资过程
- **展示内容**：
  - 多个调仓周期详情
  - 每期持仓变化（新增/移除/继续持有）
  - 连续净值曲线
  - 分周期收益统计

## 💡 权重策略

**市值加权 + 10%上限约束**

符合中国基金监管的"双十规定"（单只股票不超过基金资产净值的10%）

### 计算步骤

#### 第一步：初始权重计算
按市值比例计算每只股票的初始权重：
```
初始权重 = 股票市值 / 所有股票市值之和
```

#### 第二步：10%上限约束（迭代调整法）

**每轮迭代的处理逻辑**：

1. **识别超限股票**
   - 找出所有权重 > 10% 的股票
   - 将这些股票的权重截断为 10%
   - 计算总超出权重 = Σ(原权重 - 10%)

2. **计算分配比例**
   - 统计所有未超限股票的当前权重总和
   - 每只未超限股票的分配比例 = 该股票当前权重 / 未超限股票权重总和

3. **按比例重新分配**
   ```
   新权重 = 原权重 + (总超出权重 × 分配比例)
   ```
   
4. **重复迭代**
   - 如果分配后仍有股票超过10%，进入下一轮迭代
   - 直到所有股票权重 ≤ 10%

### 算法示例

**场景**：5只股票的市值加权组合

**初始权重**（市值加权）：
```
A股票: 15.0%  (超限 5.0%)
B股票: 12.0%  (超限 2.0%)
C股票:  8.0%  (未超限)
D股票:  5.0%  (未超限)
E股票: 60.0%  (超限 50.0%)
```

**第一轮迭代**：

1. 截断超限股票：A→10%, B→10%, E→10%
2. 总超出权重 = 5% + 2% + 50% = 57%
3. 未超限股票：C(8%) 和 D(5%)，总权重 = 13%
4. 分配比例：
   - C的比例 = 8% / 13% = 61.5%
   - D的比例 = 5% / 13% = 38.5%
5. 重新分配：
   - C = 8% + 57% × 61.5% = 43.06% (超限！)
   - D = 5% + 57% × 38.5% = 26.94% (超限！)

**第二轮迭代**：

1. 截断：C→10%, D→10%
2. 总超出权重 = 33.06% + 16.94% = 50%
3. 未超限股票：无（A、B、E已在10%）
4. 由于没有未超限股票，50%需要重新分配给A、B、E
5. A、B、E当前总权重 = 30%
6. 重新分配：
   - A = 10% + 50% × (10%/30%) = 26.67% (超限！)
   - B = 10% + 50% × (10%/30%) = 26.67% (超限！)
   - E = 10% + 50% × (10%/30%) = 26.67% (超限！)

**继续迭代**...直到收敛

**最终权重**（收敛后）：
```
A股票: 10.00%
B股票: 10.00%
C股票: 10.00%
D股票: 10.00%
E股票: 60.00%
```

💡 **注意**：E股票因为市值占比过大（60%），即使其他股票都达到10%上限，仍会保留较大权重

### 策略特点

- ✅ **合规性**：符合基金监管要求
- ✅ **经济意义**：保持市值加权的核心逻辑
- ✅ **公平性**：超出部分按比例公平分配
- ✅ **风险分散**：避免单只股票权重过高

## 📈 数据来源

| 数据类型 | 接口 | 字段 | 说明 |
|---------|------|------|------|
| 持仓数据 | `fund_portfolio` | 股票代码、持仓比例 | ETF定期报告 |
| 价格数据 | `daily` | 收盘价（后复权） | 日线行情 |
| 市值数据 | `daily_basic` | `total_mv` | 总市值（万元） |
| 基本信息 | `stock_basic` | 股票名称、行业 | 基础信息 |

## 🏗️ 技术架构

```
├── 后端
│   ├── Node.js + Express    # API服务
│   ├── Axios                # HTTP请求
│   └── Tushare API          # 金融数据
│
├── 前端
│   ├── 原生JavaScript       # 交互逻辑
│   ├── Chart.js             # 图表可视化
│   └── 响应式CSS            # 界面设计
│
└── 数据处理
    ├── 批量处理             # 避免API限流
    ├── 迭代权重调整         # 10%约束算法
    └── 净值计算             # 组合收益计算
```

## 📁 项目结构

```
hlETF/
├── server.js              # 后端服务主文件
│   ├── /api/backtest/static    # 静态回测接口
│   └── /api/backtest/dynamic   # 动态回测接口
├── public/
│   └── index.html        # 前端页面（统一回测界面）
├── package.json          # 项目配置
├── .env                  # 环境变量（需自行创建）
├── .env.example          # 环境变量示例
└── README.md            # 项目说明
```

## ⚠️ 注意事项

### Tushare权限要求
- **基础接口**（0积分）：`daily`、`stock_basic`
- **进阶接口**（2000积分）：`daily_basic`
- **高级接口**（5000积分）：`fund_portfolio`

### API调用限制
- 系统已实现批量处理和延迟机制
- 建议积分≥2000以获取完整数据
- 高频调用可能触发限流

### 回测局限性
- ⚠️ 不考虑交易成本和税费
- ⚠️ 不考虑流动性约束
- ⚠️ 不考虑冲击成本
- ⚠️ 历史表现不代表未来收益

### 数据时点说明
- **静态回测**：使用最新报告期结束日的市值
- **动态回测**：使用调仓日（报告披露后）的市值，避免前视偏差
- **调仓逻辑**：假设报告披露后立即可获得持仓信息并调仓

## 📝 版本历史

### v2.1.0 (2024-12-10)
- ✨ 新增10%上限约束，符合双十规定
- 🔧 优化权重分配算法（迭代调整法）
- 📚 完善README文档

### v2.0.0 (2024-12-09)
- 🎯 改为市值加权策略
- 🔄 简化权重计算逻辑
- 🎨 统一回测页面UI

## 📄 许可证

MIT License

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## ⚠️ 免责声明

本系统仅供学习和研究使用，不构成任何投资建议。投资有风险，入市需谨慎。
